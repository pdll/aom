"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9081],{3905:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return h}});var o=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,o,a=function(e,n){if(null==e)return{};var t,o,a={},i=Object.keys(e);for(o=0;o<i.length;o++)t=i[o],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(o=0;o<i.length;o++)t=i[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var l=o.createContext({}),d=function(e){var n=o.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},p=function(e){var n=d(e.components);return o.createElement(l.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},u=o.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=d(t),h=a,m=u["".concat(l,".").concat(h)]||u[h]||c[h]||i;return t?o.createElement(m,r(r({ref:n},p),{},{components:t})):o.createElement(m,r({ref:n},p))}));function h(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,r=new Array(i);r[0]=u;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var d=2;d<i;d++)r[d]=t[d];return o.createElement.apply(null,r)}return o.createElement.apply(null,t)}u.displayName="MDXCreateElement"},4972:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return s},contentTitle:function(){return l},metadata:function(){return d},toc:function(){return p},default:function(){return u}});var o=t(7462),a=t(3366),i=(t(7294),t(3905)),r=["components"],s={title:"Endpoints decorators",sidebar_position:2},l=void 0,d={unversionedId:"api/koa/endpoints",id:"api/koa/endpoints",isDocsHomePage:!1,title:"Endpoints decorators",description:"The routes endpoints",source:"@site/docs/api/koa/endpoints.md",sourceDirName:"api/koa",slug:"/api/koa/endpoints",permalink:"/docs/api/koa/endpoints",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Endpoints decorators",sidebar_position:2},sidebar:"api",previous:{title:"Working with Koa",permalink:"/docs/api/koa/index"},next:{title:"Bridges and Middlewares",permalink:"/docs/api/koa/middlewares"}},p=[{value:"The routes endpoints",id:"the-routes-endpoints",children:[]},{value:"Common endpoints",id:"common-endpoints",children:[]},{value:"Composite endpoints: <code>@UseNext</code>",id:"composite-endpoints-usenext",children:[]}],c={toc:p};function u(e){var n=e.components,t=(0,a.Z)(e,r);return(0,i.kt)("wrapper",(0,o.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"the-routes-endpoints"},"The routes endpoints"),(0,i.kt)("p",null,"All endpoints are created using decorators from the following list:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"@Endpoint(method = 'get'|'post'|'put'|'patch'|'delete'|'options'|'all', path)")," - creates\n",(0,i.kt)("inlineCode",{parentName:"li"},"endpoint"),", pointing to the address ",(0,i.kt)("inlineCode",{parentName:"li"},"path")," on the ",(0,i.kt)("inlineCode",{parentName:"li"},"method")," method. To create an endpoint via\nthis decorator, you must specify at least the method to be used. Calling this decorator\nwithout arguments creates a common endpoint (more details below). Default: ",(0,i.kt)("inlineCode",{parentName:"li"},"path='/'"),"."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"@Get(path)")," - shortcut for ",(0,i.kt)("inlineCode",{parentName:"li"},"@Endpoint(path, 'get')")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"@Post(path)")," - shortcut for ",(0,i.kt)("inlineCode",{parentName:"li"},"@Endpoint(path, 'post')")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"@Put(path)")," - shortcut for ",(0,i.kt)("inlineCode",{parentName:"li"},"@Endpoint(path, 'put')")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"@Patch(path)")," - shortcut for ",(0,i.kt)("inlineCode",{parentName:"li"},"@Endpoint(path, 'patch')")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"@Delete(path)")," - shortcut for ",(0,i.kt)("inlineCode",{parentName:"li"},"@Endpoint(path, 'delete')")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"@Options(path)")," - shortcut for ",(0,i.kt)("inlineCode",{parentName:"li"},"@Endpoint(path, 'options')")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"@All(path)")," - shortcut for ",(0,i.kt)("inlineCode",{parentName:"li"},"@Endpoint(path, 'all')"))),(0,i.kt)("p",null,"All shortcuts decorators are applied over static class methods without a second argument.\nThe use of the second argument applies only to common endpoints (described below), and\nis used as class decorators."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"path")," value can have several levels of nesting, and even contain a typical ",(0,i.kt)("inlineCode",{parentName:"p"},"koa-router")," parameter.\nAs the value of the link, a fragment of the address is used, which characterizes this method exclusively\nwithin the given route node. The full name of the address will be built based on all links,\nwhich preceded the given ",(0,i.kt)("inlineCode",{parentName:"p"},"endpoint"),"."),(0,i.kt)("p",null,"The specified decorators are applied as follows:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},'// ... index.ts\nimport { Get, Post, Body } from "aom";\n\nclass Index {\n  @Get()\n  static Hello() {\n    return `Hello, I\'m aom`;\n  }\n\n  @Post("/save")\n  static Save(@Body() body: any) {\n    return body;\n  }\n\n  @Get("/choose/:variant")\n  static Variant(@Params("variant") variant) {\n    return { variant };\n  }\n}\n')),(0,i.kt)("p",null,"This will create a route node with methods: ",(0,i.kt)("inlineCode",{parentName:"p"},"GET /"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"POST /save")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"GET /choose/:variant"),",\nwhich, after connecting to the route map, will provide access to them using the declared prefixes."),(0,i.kt)("h2",{id:"common-endpoints"},"Common endpoints"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"aom")," allows you to create common endpoints, allowing you to reuse the same code in different\nplaces at a different access address and, if necessary, in a different method."),(0,i.kt)("p",null,"To declare a class method as a common endpoint, use the ",(0,i.kt)("inlineCode",{parentName:"p"},"@Endpoint()")," decorator with no arguments.\nThen this method can be used as the second argument for the shortcut decorators applied to the\nclass in which you want to use these methods."),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},'// let\'s create two common endpoints that use the value of the data model from the context state\nclass Data {\n  @Endpoint()\n  static List(@State() { model }, @Query() query) {\n    return model.find({ ...query });\n  }\n\n  @Endpoint()\n  static Add(@State() { model }, @Body() body) {\n    return model.create({ ...body });\n  }\n}\n\n// create a route node in which the `Users` data model will be declared upon initiation\n// and connect the previously declared destination points to it by the specified path and methods\n@Use(Users.Init)\n@Get("/", Data.List)\n@Post("/", Data.Add)\nclass Users {\n  model = models.Users;\n\n  @Middleware()\n  static Init(@State() state, @This() { model }: Users, @Next() next) {\n    Object.assign(state, { model });\n    return next();\n  }\n}\n\n// create a route node in which the `Customers` data model will be declared upon initiation\n// and connect the previously declared destination points to it by the specified path and methods\n@Use(Customers.Init)\n@Get("/", Data.List)\n@Post("/", Data.Add)\nclass Customers {\n  model = models.Customers;\n\n  @Middleware()\n  static Init(@State() state, @This() { model }: Users, @Next() next) {\n    Object.assign(state, { model });\n    return next();\n  }\n}\n')),(0,i.kt)("p",null,'Only methods that were invoked as "common" decorators can be used as the second argument for\nthe ',(0,i.kt)("inlineCode",{parentName:"p"},"Get"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"Post"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"Put"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"Patch"),"/ ",(0,i.kt)("inlineCode",{parentName:"p"},"Options"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"Delete"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"All")," decorators. Otherwise, the build will\nthrow an error."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Important!"),' The context of "common" endpoints is the class in which they are declared: that is,\nthe default ',(0,i.kt)("inlineCode",{parentName:"p"},"@This")," decorator will use its own class (in the example, ",(0,i.kt)("inlineCode",{parentName:"p"},"Data"),"), and the\nreturn value of the ",(0,i.kt)("inlineCode",{parentName:"p"},"@Route()")," with different calls will differ only in the values of ",(0,i.kt)("inlineCode",{parentName:"p"},"path")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"method"),"."),(0,i.kt)("h2",{id:"composite-endpoints-usenext"},"Composite endpoints: ",(0,i.kt)("inlineCode",{parentName:"h2"},"@UseNext")),(0,i.kt)("p",null,"Route endpoints can be formed from building blocks. For example, when implementing mechanisms\nthat imply different conditions for entering the endpoint and the same data structures at the output."),(0,i.kt)("p",null,"To create a composite destination, the ",(0,i.kt)("inlineCode",{parentName:"p"},"@UseNext")," decorator is used, the argument of which is a\npointer to the general endpoint, which will be called if ",(0,i.kt)("inlineCode",{parentName:"p"},"next()")," was returned."),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},'class Auth {\n  login: AuthLogins;\n\n  @Post("/login")\n  @Summary("Login/password authentication")\n  @RequestBody({\n    schema: LoginForm,\n  })\n  @Requests({\n    status: 400,\n    schema: ErrorResponse,\n  })\n  @UseNext(Auth.GenerateTokens) // define the next elements in the chain `Auth.GenerateTokens` method\n  static async Login(\n    @SafeBody(LoginForm) { login, password }: LoginForm,\n    @This() auth: Auth,\n    @Err() err,\n    @Next() next\n  ) {\n    // find a login with the "custom" type\n    auth.login = await AuthLogins.findOne({ login, type: "custom" });\n    // return an error if the login is not found\n    if (!auth.login) {\n      return err("login not found", 400);\n    }\n    // return an error if the password is incorrect\n    if (auth.login.checkPassword(password)) {\n      return err("wrong password", 400);\n    }\n    // otherwise, go to the next function - generating a token for authorization\n    return next();\n  }\n\n  // create a middleware for checking\n  @Middleware()\n  @Responses({\n    status: 400,\n    schema: ErrorResponse,\n  })\n  static async CheckPhoneNumber(@This() auth: Auth, @Body() { login }, @Err() err, @Next() next) {\n    // find a login with the type "phone"\n    auth.login = await AuthLogins.findOne({ login, type: "phone" });\n    // return error response if login not found\n    if (!auth.login) {\n      return err("login not found", 400);\n    }\n    return next();\n  }\n\n  @Post("/request-code")\n  @Summary("Request authorization by phone number")\n  @RequestBody({\n    schema: RequestCodeForm,\n  })\n  @Responses({\n    status: 200,\n    schema: MessageResponse,\n  })\n  @Use(Auth.CheckPhoneNumber) // first check that such a login exists\n  static async RequestCode(@This() { login }: Auth) {\n    await login.sendOneOffCode(); // generate and send a one-off code\n    return { message: "Code sent by SMS" };\n  }\n\n  @Post("/confirm-code")\n  @Summary("Confirm authorization by phone number")\n  @RequestBody({\n    schema: ConfirmCodeForm,\n  })\n  @Requests({\n    status: 400,\n    schema: ErrorResponse,\n  })\n  @Use(Auth.CheckPhoneNumber) // first check that such a login exists\n  @UseNext(Auth.GenerateTokens) // define the next elements in the chain `Auth.GenerateTokens` method\n  static ConfirmCode(\n    @SafeBody(ConfirmCodeForm) { code }: ConfirmCodeForm,\n    @This() { login }: Auth,\n    @Err() err,\n    @Next() next\n  ) {\n    // check that the specified one-off code is valid\n    const codeIsValid = await login.checkOneOffCode(code);\n    // return the error if code not valid\n    if (!codeIsValid) {\n      return err("wrong code", 400);\n    }\n    // otherwise, go to the next function - generating a token for authorization\n    return next();\n  }\n\n  // create common endpoint\n  @Endpoint()\n  // describe returned data schema\n  @Responses({\n    status: 200,\n    schema: AuthTokens,\n  })\n  // since it is called after all other checks have passed, all data in it is safe\n  // and can be used directly at the time of the call\n  static GenerateTokens(@This() { login }: Auth) {\n    const { _id: loginId } = login;\n    const newToken = new AuthTokens({ loginId });\n    const lifetime = 60 * 60 * 1000; //\n    await newToken.generateRandomData(lifetime);\n    return newToken;\n  }\n}\n')),(0,i.kt)("p",null,"The length of a compound route can be of any length. In this case, for each common endpoint, add\nthe ",(0,i.kt)("inlineCode",{parentName:"p"},"@UseNext")," decorator specifying the next function to be called, and return the ",(0,i.kt)("inlineCode",{parentName:"p"},"next()")," value\nin it if its logic is successful."),(0,i.kt)("p",null,"If a composite route fragment uses ",(0,i.kt)("inlineCode",{parentName:"p"},"middleware"),", then they will be added to the cursors call sequence."))}u.isMDXComponent=!0}}]);